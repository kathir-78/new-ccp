<!DOCTYPE html>
<html>
<body>
  <div id="ccp" style="display:none"></div>

  <script src="https://unpkg.com/amazon-connect-streams@1.7.8/release/connect-streams-min.js"></script>
  <script>
    const CCP_URL = "https://p3-sample.my.connect.aws/ccp-v2/";
    const REGION = "us-east-1";

    connect.core.initCCP(document.getElementById("ccp"), {
      ccpUrl: CCP_URL,
      region: REGION,
      loginPopup: true,
      loginPopupAutoClose: true,
      softphone: { allowFramedSoftphone: true }
    });

    connect.contact(contact => {
      const contactId = contact.getContactId();

      contact.onIncoming(() => emit({
        type: "CALL_STATE",
        status: "RINGING",
        phone: getPhone(contact),
        contactId
      }));

      contact.onConnected(() => emit({
        type: "CALL_STATE",
        status: "CONNECTED",
        phone: getPhone(contact),
        contactId
      }));

      contact.onEnded(() => emit({
        type: "CALL_STATE",
        status: "IDLE",
        contactId
      }));
    });

    function emit(data) {
      console.log("ðŸ“¤ CCP emitting:", data);
      window.opener?.postMessage(data, "*");
    }

    function getPhone(contact) {
      return contact.getActiveInitialConnection()
        ?.getEndpoint()
        ?.phoneNumber || "";
    }
  </script>
</body>
</html>
