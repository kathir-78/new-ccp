<!DOCTYPE html>
<html>
<body>
  <div id="ccp" style="display:none"></div>

  <script src="https://unpkg.com/amazon-connect-streams@1.7.8/release/connect-streams-min.js"></script>
  <script>
    const HUBSPOT_ORIGIN = "https://app.hubspot.com";
    const CCP_URL = "https://p3-sample.my.connect.aws/ccp-v2/";
    const REGION = "us-east-1";

    let activeContact = null;
    let agent = null;

    connect.core.initCCP(document.getElementById("ccp"), {
      ccpUrl: CCP_URL,
      region: REGION,
      loginPopup: true,
      loginPopupAutoClose: true,
      softphone: { allowFramedSoftphone: true }
    });

    connect.agent(a => agent = a);

    connect.contact(contact => {
      activeContact = contact;
      const contactId = contact.getContactId();

      contact.onIncoming(() => emit({
        type: "CALL_STATE",
        status: "RINGING",
        contactId,
        phone: getPhone(contact)
      }));

      contact.onConnected(() => emit({
        type: "CALL_STATE",
        status: "CONNECTED",
        contactId,
        phone: getPhone(contact)
      }));

      contact.onEnded(() => emit({
        type: "CALL_STATE",
        status: "IDLE",
        contactId
      }));
    });

    function emit(data) {
      window.opener?.postMessage(data, HUBSPOT_ORIGIN);
    }

    function getPhone(contact) {
      return contact.getActiveInitialConnection()?.getEndpoint()?.phoneNumber || "";
    }
  </script>
</body>
</html>


